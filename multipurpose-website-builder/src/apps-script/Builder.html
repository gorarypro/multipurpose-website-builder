<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>Multipurpose Website Builder</title>

    <!-- Bootstrap 5 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <style>
      body {
        padding: 1.5rem;
      }
      .step {
        display: none;
      }
      .step.active {
        display: block;
      }
      .step-indicator {
        font-weight: 600;
        margin-bottom: 1rem;
      }
      .sidebar-steps .list-group-item {
        cursor: pointer;
      }
      .sidebar-steps .list-group-item.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
      }
      .form-section-title {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #6c757d;
        font-weight: 600;
        margin-bottom: 0.4rem;
      }
      .card-section {
        margin-bottom: 1.25rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- HEADER -->
      <div class="d-flex align-items-center mb-3">
        <div>
          <h1 class="h3 mb-1">Multipurpose Website Builder</h1>
          <p class="text-muted mb-0">
            Configure your site step by step. Your configuration is stored in Google Sheets.
          </p>
        </div>
        <div class="ms-auto d-none d-md-block">
          <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
            Builder UI
          </span>
        </div>
      </div>

      <!-- STEPS LAYOUT -->
      <div class="row">
        <!-- LEFT: STEP NAV -->
        <div class="col-md-3 mb-3 mb-md-0">
          <div class="list-group sidebar-steps" id="stepNav">
            <button
              type="button"
              class="list-group-item list-group-item-action active"
              data-step="1"
            >
              <div class="fw-semibold">1. Branding</div>
              <small class="text-muted">Site title, logo, main color</small>
            </button>
            <button
              type="button"
              class="list-group-item list-group-item-action"
              data-step="2"
            >
              <div class="fw-semibold">2. Language & Currency</div>
              <small class="text-muted">Locales & currency symbol</small>
            </button>
            <button
              type="button"
              class="list-group-item list-group-item-action"
              data-step="3"
            >
              <div class="fw-semibold">3. Components & Data</div>
              <small class="text-muted">Sections, data source, contact</small>
            </button>
            <button
              type="button"
              class="list-group-item list-group-item-action"
              data-step="4"
            >
              <div class="fw-semibold">4. Theme Export & GitHub</div>
              <small class="text-muted">Generate & push Blogger theme</small>
            </button>
          </div>
        </div>

        <!-- RIGHT: STEP CONTENT -->
        <div class="col-md-9">
          <div id="stepIndicator" class="step-indicator mb-3">
            Step 1 of 4
          </div>

          <!-- ================================ -->
          <!-- STEP 1 ‚Äî BRANDING               -->
          <!-- ================================ -->
          <div class="step active" data-step="1">
            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">Brand Basics</div>
                <div class="mb-3">
                  <label class="form-label">Site Title</label>
                  <input
                    type="text"
                    class="form-control"
                    id="siteTitle"
                    placeholder="My Store"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Logo Text</label>
                  <input
                    type="text"
                    class="form-control"
                    id="logoText"
                    placeholder="MyBrand"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Primary Color (HEX)</label>
                  <div class="input-group">
                    <span class="input-group-text">#</span>
                    <input
                      type="text"
                      class="form-control"
                      id="primaryColor"
                      placeholder="0d6efd"
                    />
                  </div>
                  <div class="form-text">
                    This affects buttons, links and highlights in your theme.
                  </div>
                </div>
              </div>
            </div>

            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">Hero Section</div>
                <div class="mb-3">
                  <label class="form-label">Hero Title</label>
                  <input
                    type="text"
                    class="form-control"
                    id="heroTitle"
                    placeholder="Delicious Event Sushi Delivered"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Hero Subtitle</label>
                  <textarea
                    class="form-control"
                    id="heroSubtitle"
                    rows="2"
                    placeholder="Catering, events, and platters made fresh."
                  ></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Hero Image URL</label>
                  <input
                    type="text"
                    class="form-control"
                    id="heroImageUrl"
                    placeholder="https://example.com/hero.jpg"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- ======================================= -->
          <!-- STEP 2 ‚Äî LANGUAGE & CURRENCY           -->
          <!-- ======================================= -->
          <div class="step" data-step="2">
            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">Languages</div>
                <div class="mb-3">
                  <label class="form-label">Language Mode</label>
                  <select id="languageMode" class="form-select">
                    <option value="single">Single language</option>
                    <option value="multi">Multi-language</option>
                  </select>
                  <div class="form-text">
                    For multi-language, use the <strong>TextMapping</strong> sheet
                    to define translations.
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Default Language</label>
                  <select id="defaultLanguage" class="form-select">
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">Currency</div>
                <div class="mb-3">
                  <label class="form-label">Currency Symbol</label>
                  <input
                    type="text"
                    id="currencySymbol"
                    class="form-control"
                    placeholder="$"
                  />
                  <div class="form-text">
                    Appears next to prices (e.g., $, ‚Ç¨, MAD).
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ======================================= -->
          <!-- STEP 3 ‚Äî COMPONENTS & DATA             -->
          <!-- ======================================= -->
          <div class="step" data-step="3">
            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">Page Components</div>

                <div class="form-check form-switch mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="navbarIncluded"
                    checked
                  />
                  <label class="form-check-label" for="navbarIncluded">
                    Include Navbar
                  </label>
                </div>

                <div class="form-check form-switch mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="heroIncluded"
                    checked
                  />
                  <label class="form-check-label" for="heroIncluded">
                    Include Hero Section
                  </label>
                </div>

                <div class="form-check form-switch mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="formsIncluded"
                    checked
                  />
                  <label class="form-check-label" for="formsIncluded">
                    Include Contact / Lead Form
                  </label>
                </div>

                <div class="form-check form-switch mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="testimonialsIncluded"
                    checked
                  />
                  <label class="form-check-label" for="testimonialsIncluded">
                    Include Testimonials Section
                  </label>
                </div>

                <div class="form-check form-switch mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="pricingIncluded"
                    checked
                  />
                  <label class="form-check-label" for="pricingIncluded">
                    Include Pricing Section
                  </label>
                </div>

                <div class="form-check form-switch mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="popupIncluded"
                  />
                  <label class="form-check-label" for="popupIncluded">
                    Include Timed Popup
                  </label>
                </div>

                <div id="popupOptions" class="mt-3" style="display:none;">
                  <div class="mb-3">
                    <label class="form-label">Popup Delay (seconds)</label>
                    <input
                      type="number"
                      class="form-control"
                      id="popupDelaySeconds"
                      placeholder="60"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Popup HTML Content</label>
                    <textarea
                      class="form-control"
                      id="popupHtml"
                      rows="3"
                      placeholder="<p>Subscribe to our newsletter.</p>"
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>

            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">E-commerce</div>

                <div class="form-check form-switch mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="ecommerceIncluded"
                  />
                  <label class="form-check-label" for="ecommerceIncluded">
                    Enable E-commerce Features (cart, wishlist)
                  </label>
                </div>

                <div id="ecommerceOptions" style="display:none;">
                  <div class="form-check form-switch mb-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="cartIncluded"
                    />
                    <label class="form-check-label" for="cartIncluded">
                      Include Cart
                    </label>
                  </div>
                  <div class="form-check form-switch mb-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="wishlistIncluded"
                    />
                    <label class="form-check-label" for="wishlistIncluded">
                      Include Wishlist
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">Data Source</div>

                <div class="mb-3">
                  <label class="form-label">Product Source</label>
                  <select id="productSource" class="form-select">
                    <option value="blogger">Blogger</option>
                    <option value="wordpress">WordPress / WooCommerce</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Blogger Feed URL</label>
                  <input
                    type="text"
                    class="form-control"
                    id="bloggerFeedUrl"
                    placeholder="https://yourblog.blogspot.com/feeds/posts/default?alt=json&max-results=50"
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label">WordPress API URL</label>
                  <input
                    type="text"
                    class="form-control"
                    id="wpApiUrl"
                    placeholder="https://your-site.com/wp-json/wc/v3/products"
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label">WordPress Auth Key / Token</label>
                  <input
                    type="text"
                    class="form-control"
                    id="wpAuthKey"
                    placeholder="ck_xxx:cs_xxx or Bearer token"
                  />
                </div>
              </div>
            </div>

            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">Contact & Legal</div>

                <div class="mb-3">
                  <label class="form-label">Contact Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="contactEmail"
                    placeholder="you@example.com"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Contact Phone</label>
                  <input
                    type="text"
                    class="form-control"
                    id="contactPhone"
                    placeholder="+212 6 00 00 00 00"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">WhatsApp Number</label>
                  <input
                    type="text"
                    class="form-control"
                    id="contactWhatsapp"
                    placeholder="+212 6 00 00 00 00"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Privacy Policy URL</label>
                  <input
                    type="text"
                    class="form-control"
                    id="privacyUrl"
                    placeholder="https://example.com/privacy"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Terms & Conditions URL</label>
                  <input
                    type="text"
                    class="form-control"
                    id="termsUrl"
                    placeholder="https://example.com/terms"
                  />
                </div>
              </div>
            </div>

            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">Analytics</div>
                <div class="mb-3">
                  <label class="form-label">Google Analytics / GA4 ID</label>
                  <input
                    type="text"
                    class="form-control"
                    id="gaId"
                    placeholder="G-XXXXXXX"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- ======================================= -->
          <!-- STEP 4 ‚Äî THEME EXPORT & GITHUB          -->
          <!-- ======================================= -->
          <div class="step" data-step="4">
            <div class="card card-section mb-3">
              <div class="card-body">
                <div class="form-section-title">Theme Export</div>
                <p class="text-muted mb-3">
                  Choose a unique theme name. We‚Äôll generate the Blogger theme
                  XML and store it in the <strong>Themes</strong> sheet.
                  If GitHub is enabled in the Settings sheet, you can push it
                  automatically.
                </p>

                <div class="mb-3">
                  <label class="form-label fw-semibold">Theme Name</label>
                  <input
                    type="text"
                    id="themeName"
                    class="form-control"
                    placeholder="MyTheme"
                  />
                </div>

                <div class="form-check my-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="pushGithub"
                  />
                  <label class="form-check-label" for="pushGithub">
                    Also push to GitHub (requires <code>github_* </code>settings
                    in the Settings sheet)
                  </label>
                </div>

                <button id="exportThemeBtn" class="btn btn-primary mt-3">
                  <i class="bi bi-cloud-arrow-up me-1"></i>
                  Generate Theme
                </button>

                <div id="exportStatus" class="small text-muted mt-3"></div>
              </div>
            </div>

            <div class="card card-section">
              <div class="card-body">
                <div class="form-section-title">GitHub Configuration (Sheet)</div>
                <p class="small text-muted mb-2">
                  These values are stored in the <strong>Settings</strong> sheet
                  (keys:
                  <code>github_repo</code>,
                  <code>github_branch</code>,
                  <code>github_token</code>).
                  You can edit them directly in Sheets or here and click
                  <strong>Save</strong>.
                </p>

                <div class="mb-3">
                  <label class="form-label">GitHub Repository (owner/repo)</label>
                  <input
                    type="text"
                    class="form-control"
                    id="githubRepo"
                    placeholder="yourname/multipurpose-website-builder"
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label">GitHub Branch</label>
                  <input
                    type="text"
                    class="form-control"
                    id="githubBranch"
                    placeholder="main"
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label">GitHub Token (stored in sheet)</label>
                  <input
                    type="password"
                    class="form-control"
                    id="githubToken"
                    placeholder="ghp_xxx..."
                  />
                  <div class="form-text">
                    The token must have <code>repo</code> scope and rights to
                    push to the repository.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- GLOBAL FOOTER BUTTONS -->
          <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-secondary" id="prevBtn">
              <i class="bi bi-arrow-left"></i> Previous
            </button>
            <div>
              <button class="btn btn-secondary me-2" id="saveBtn">
                <i class="bi bi-save"></i> Save Settings
              </button>
              <button class="btn btn-primary" id="nextBtn">
                Next <i class="bi bi-arrow-right"></i>
              </button>
            </div>
          </div>

          <div id="status" class="mt-3 small text-muted"></div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (for any future use, modals, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let currentStep = 1;
      const maxStep = 4;
      const state = {};

      function showStep(step) {
        document.querySelectorAll(".step").forEach(function (el) {
          el.classList.toggle("active", Number(el.dataset.step) === step);
        });

        // Update sidebar active state
        document.querySelectorAll("#stepNav .list-group-item").forEach(
          function (btn) {
            btn.classList.toggle(
              "active",
              Number(btn.getAttribute("data-step")) === step
            );
          }
        );

        const indicator = document.getElementById("stepIndicator");
        indicator.textContent = "Step " + step + " of " + maxStep;

        document.getElementById("prevBtn").disabled = step === 1;
        document.getElementById("nextBtn").textContent =
          step === maxStep ? "Finish" : "Next";
      }

      function collectState() {
        // Step 1
        state.site_title = document.getElementById("siteTitle").value || "";
        state.logo_text = document.getElementById("logoText").value || "";
        state.primary_color =
          document.getElementById("primaryColor").value || "";

        state.hero_title = document.getElementById("heroTitle").value || "";
        state.hero_subtitle =
          document.getElementById("heroSubtitle").value || "";
        state.hero_image_url =
          document.getElementById("heroImageUrl").value || "";

        // Step 2
        state.language_mode =
          document.getElementById("languageMode").value || "single";
        state.default_language =
          document.getElementById("defaultLanguage").value || "en";
        state.currency_symbol =
          document.getElementById("currencySymbol").value || "$";

        // Step 3 ‚Äì components
        state.navbar_included = document.getElementById("navbarIncluded")
          .checked
          ? "yes"
          : "no";
        state.hero_included = document.getElementById("heroIncluded").checked
          ? "yes"
          : "no";
        state.forms_included = document.getElementById("formsIncluded").checked
          ? "yes"
          : "no";
        state.testimonials_included = document.getElementById(
          "testimonialsIncluded"
        ).checked
          ? "yes"
          : "no";
        state.pricing_included = document.getElementById("pricingIncluded")
          .checked
          ? "yes"
          : "no";

        state.popup_included = document.getElementById("popupIncluded")
          .checked
          ? "yes"
          : "no";
        state.popup_delay_seconds =
          document.getElementById("popupDelaySeconds").value || "";
        state.popup_html = document.getElementById("popupHtml").value || "";

        // E-commerce
        state.ecommerce_included = document.getElementById("ecommerceIncluded")
          .checked
          ? "yes"
          : "no";
        state.cart_included = document.getElementById("cartIncluded").checked
          ? "yes"
          : "no";
        state.wishlist_included = document.getElementById(
          "wishlistIncluded"
        ).checked
          ? "yes"
          : "no";

        // Data source
        state.product_source =
          document.getElementById("productSource").value || "blogger";
        state.blogger_feed_url =
          document.getElementById("bloggerFeedUrl").value || "";
        state.wp_api_url = document.getElementById("wpApiUrl").value || "";
        state.wp_auth_key = document.getElementById("wpAuthKey").value || "";

        // Contact & legal
        state.contact_email =
          document.getElementById("contactEmail").value || "";
        state.contact_phone =
          document.getElementById("contactPhone").value || "";
        state.contact_whatsapp =
          document.getElementById("contactWhatsapp").value || "";
        state.privacy_url =
          document.getElementById("privacyUrl").value || "";
        state.terms_url = document.getElementById("termsUrl").value || "";

        // Analytics
        state.ga_id = document.getElementById("gaId").value || "";

        // GitHub (stored in Settings sheet)
        state.github_repo =
          document.getElementById("githubRepo").value || "";
        state.github_branch =
          document.getElementById("githubBranch").value || "";
        state.github_token =
          document.getElementById("githubToken").value || "";
      }

      function applySettings(settings) {
        if (!settings) return;

        // Step 1
        if (settings.site_title)
          document.getElementById("siteTitle").value = settings.site_title;
        if (settings.logo_text)
          document.getElementById("logoText").value = settings.logo_text;
        if (settings.primary_color)
          document.getElementById("primaryColor").value =
            settings.primary_color;

        if (settings.hero_title)
          document.getElementById("heroTitle").value = settings.hero_title;
        if (settings.hero_subtitle)
          document.getElementById("heroSubtitle").value =
            settings.hero_subtitle;
        if (settings.hero_image_url)
          document.getElementById("heroImageUrl").value =
            settings.hero_image_url;

        // Step 2
        if (settings.language_mode)
          document.getElementById("languageMode").value =
            settings.language_mode;
        if (settings.default_language)
          document.getElementById("defaultLanguage").value =
            settings.default_language;
        if (settings.currency_symbol)
          document.getElementById("currencySymbol").value =
            settings.currency_symbol;

        // Step 3 ‚Äì components
        document.getElementById("navbarIncluded").checked =
          (settings.navbar_included || "yes") === "yes";
        document.getElementById("heroIncluded").checked =
          (settings.hero_included || "yes") === "yes";
        document.getElementById("formsIncluded").checked =
          (settings.forms_included || "yes") === "yes";
        document.getElementById("testimonialsIncluded").checked =
          (settings.testimonials_included || "yes") === "yes";
        document.getElementById("pricingIncluded").checked =
          (settings.pricing_included || "yes") === "yes";

        document.getElementById("popupIncluded").checked =
          (settings.popup_included || "no") === "yes";
        if (settings.popup_delay_seconds)
          document.getElementById("popupDelaySeconds").value =
            settings.popup_delay_seconds;
        if (settings.popup_html)
          document.getElementById("popupHtml").value = settings.popup_html;

        document.getElementById("ecommerceIncluded").checked =
          (settings.ecommerce_included || "no") === "yes";
        document.getElementById("cartIncluded").checked =
          (settings.cart_included || "no") === "yes";
        document.getElementById("wishlistIncluded").checked =
          (settings.wishlist_included || "no") === "yes";

        if (settings.product_source)
          document.getElementById("productSource").value =
            settings.product_source;
        if (settings.blogger_feed_url)
          document.getElementById("bloggerFeedUrl").value =
            settings.blogger_feed_url;
        if (settings.wp_api_url)
          document.getElementById("wpApiUrl").value = settings.wp_api_url;
        if (settings.wp_auth_key)
          document.getElementById("wpAuthKey").value = settings.wp_auth_key;

        if (settings.contact_email)
          document.getElementById("contactEmail").value =
            settings.contact_email;
        if (settings.contact_phone)
          document.getElementById("contactPhone").value =
            settings.contact_phone;
        if (settings.contact_whatsapp)
          document.getElementById("contactWhatsapp").value =
            settings.contact_whatsapp;
        if (settings.privacy_url)
          document.getElementById("privacyUrl").value = settings.privacy_url;
        if (settings.terms_url)
          document.getElementById("termsUrl").value = settings.terms_url;

        if (settings.ga_id)
          document.getElementById("gaId").value = settings.ga_id;

        // GitHub
        if (settings.github_repo)
          document.getElementById("githubRepo").value = settings.github_repo;
        if (settings.github_branch)
          document.getElementById("githubBranch").value =
            settings.github_branch;
        if (settings.github_token)
          document.getElementById("githubToken").value =
            settings.github_token;

        // Toggle dependent panels
        toggleEcommerceOptions();
        togglePopupOptions();
      }

      function saveSettings() {
        collectState();
        const statusEl = document.getElementById("status");
        statusEl.textContent = "Saving...";

        google.script.run
          .withSuccessHandler(function (res) {
            if (res && res.status === "ok") {
              statusEl.textContent = "‚úÖ Settings saved.";
            } else {
              statusEl.textContent = "‚ö†Ô∏è Save returned an unexpected result.";
            }
          })
          .withFailureHandler(function (err) {
            statusEl.textContent = "‚ùå Error: " + err.message;
          })
          .saveSettings(JSON.stringify(state));
      }

      function loadSettingsOnStart() {
        const statusEl = document.getElementById("status");
        statusEl.textContent = "Loading settings...";

        google.script.run
          .withSuccessHandler(function (res) {
            if (res && res.status === "ok") {
              applySettings(res.settings);
              statusEl.textContent = "Settings loaded.";
            } else {
              statusEl.textContent = "‚ö†Ô∏è Could not load settings.";
            }
          })
          .withFailureHandler(function (err) {
            statusEl.textContent = "‚ùå Load error: " + err.message;
          })
          .getSettings();
      }

      function toggleEcommerceOptions() {
        const checked = document.getElementById("ecommerceIncluded").checked;
        document.getElementById("ecommerceOptions").style.display = checked
          ? "block"
          : "none";
      }

      function togglePopupOptions() {
        const checked = document.getElementById("popupIncluded").checked;
        document.getElementById("popupOptions").style.display = checked
          ? "block"
          : "none";
      }

      function initBuilder() {
        // Sidebar step navigation
        document
          .querySelectorAll("#stepNav .list-group-item")
          .forEach(function (btn) {
            btn.addEventListener("click", function () {
              const step = Number(btn.getAttribute("data-step"));
              currentStep = step;
              showStep(currentStep);
            });
          });

        document
          .getElementById("nextBtn")
          .addEventListener("click", function () {
            if (currentStep < maxStep) {
              currentStep++;
              showStep(currentStep);
            } else {
              // On last step, just save settings
              saveSettings();
            }
          });

        document
          .getElementById("prevBtn")
          .addEventListener("click", function () {
            if (currentStep > 1) {
              currentStep--;
              showStep(currentStep);
            }
          });

        document
          .getElementById("saveBtn")
          .addEventListener("click", function () {
            saveSettings();
          });

        // Toggles
        document
          .getElementById("ecommerceIncluded")
          .addEventListener("change", toggleEcommerceOptions);
        document
          .getElementById("popupIncluded")
          .addEventListener("change", togglePopupOptions);

        // Initial state
        toggleEcommerceOptions();
        togglePopupOptions();
        showStep(currentStep);
        loadSettingsOnStart();
      }

            // ================================
            // STEP 4 ‚Äî Theme Export & GitHub
            // ================================
            document.addEventListener("DOMContentLoaded", function () {
              initBuilder();

              const exportBtn = document.getElementById("exportThemeBtn");
              if (!exportBtn) return;

              exportBtn.addEventListener("click", function () {
                const name = document.getElementById("themeName").value.trim();
                const push = document.getElementById("pushGithub").checked;
                const status = document.getElementById("exportStatus");

                if (!name) {
                  status.textContent = "‚ö†Ô∏è Please enter a theme name.";
                  return;
                }

                // 1) SAVE SETTINGS FIRST (including github_* from Step 4)
                status.textContent = "üíæ Saving settings before export...";
                collectState(); // fills the global `state` object

                google.script.run
                  .withSuccessHandler(function (saveRes) {
                    // We don't care too much about the content, just continue if no error
                    if (!saveRes || saveRes.status !== "ok") {
                      status.textContent =
                        "‚ö†Ô∏è Settings save may have failed, continuing anyway...";
                    } else {
                      status.textContent = "‚è≥ Generating theme...";
                    }

                    // 2) GENERATE THE THEME (Base64-encoded)
                    google.script.run
                      .withSuccessHandler(function (res) {
                        if (!res || res.status !== "ok") {
                          status.textContent = "‚ùå Error: " + (res && res.message);
                          return;
                        }

                        // Decode Base64 XML
                        var xml = atob(res.xml);

                        // 3) SAVE THEME XML TO SHEET
                        status.textContent = "‚è≥ Saving theme to sheet...";

                        google.script.run
                          .withSuccessHandler(function (r2) {
                            if (!r2 || r2.status !== "ok") {
                              status.textContent =
                                "‚ùå Save failed: " + (r2 && r2.message);
                              return;
                            }

                            if (!push) {
                              status.textContent =
                                "‚úÖ Theme saved to sheet as: " + name;
                              return;
                            }

                            // 4) OPTIONAL: PUSH TO GITHUB
                            status.textContent =
                              "‚è≥ Saved. Pushing to GitHub (check permissions)...";

                            google.script.run
                              .withSuccessHandler(function (r3) {
                                if (r3 && r3.status === "ok") {
                                  status.textContent =
                                    "‚úÖ Theme saved & pushed to GitHub: " + r3.path;
                                } else {
                                  status.textContent =
                                    "‚ö†Ô∏è Saved locally but GitHub push failed: " +
                                    (r3 && r3.message);
                                }
                              })
                              .withFailureHandler(function (err) {
                                status.textContent =
                                  "‚ö†Ô∏è GitHub push FAILED: " + err.message;
                              })
                              .pushThemeToGitHub(name);
                          })
                          .withFailureHandler(function (err) {
                            status.textContent = "‚ùå Could not save: " + err.message;
                          })
                          .saveThemeXml(name, xml);
                      })
                      .withFailureHandler(function (err) {
                        status.textContent =
                          "‚ùå Theme generation failed: " + err.message;
                      })
                      .generateTheme(name);
                  })
                  .withFailureHandler(function (err) {
                    status.textContent =
                      "‚ùå Could not save settings before export: " + err.message;
                  })
                  .saveSettings(JSON.stringify(state));
              });
            });

    </script>
  </body>
</html>
