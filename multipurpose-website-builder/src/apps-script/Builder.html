<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>Multipurpose Website Builder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
      body { padding: 1.5rem; }
      .step { display: none; }
      .step.active { display: block; }
      .step-indicator { font-weight: 600; margin-bottom: 1rem; }
      .step-title { display:flex; align-items:center; gap:.5rem; }
      .step-title span.badge { font-size:.75rem; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-1">Multipurpose Website Builder</h1>
      <p class="text-muted mb-4">Configure your site step by step. Your configuration is stored in Google Sheets.</p>

      <div id="stepIndicator" class="step-indicator">Step 1 of 4</div>

      <!-- Step 1: Branding -->
      <div class="step active" data-step="1">
        <div class="step-title mb-3">
          <h4 class="mb-0">Branding</h4>
          <span class="badge bg-secondary">Step 1</span>
        </div>
        <div class="mb-3">
          <label class="form-label">Site Title</label>
          <input type="text" class="form-control" id="siteTitle">
        </div>
        <div class="mb-3">
          <label class="form-label">Logo Text</label>
          <input type="text" class="form-control" id="logoText">
        </div>
        <div class="mb-3">
          <label class="form-label">Primary Color (HEX)</label>
          <input type="text" class="form-control" id="primaryColor" placeholder="#0d6efd">
        </div>
      </div>

      <!-- Step 2: Language & Currency -->
      <div class="step" data-step="2">
        <div class="step-title mb-3">
          <h4 class="mb-0">Language &amp; Currency</h4>
          <span class="badge bg-secondary">Step 2</span>
        </div>
        <div class="mb-3">
          <label class="form-label">Language Mode</label>
          <select id="languageMode" class="form-select">
            <option value="single">Single language</option>
            <option value="multi">Multi-language</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Default Language</label>
          <select id="defaultLanguage" class="form-select">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="ar">العربية</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Currency Symbol</label>
          <input type="text" id="currencySymbol" class="form-control" placeholder="$">
        </div>
      </div>

      <!-- Step 3: Components & Ecommerce -->
      <div class="step" data-step="3">
        <div class="step-title mb-3">
          <h4 class="mb-0">Components &amp; E-commerce</h4>
          <span class="badge bg-secondary">Step 3</span>
        </div>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="navbarIncluded" checked>
          <label class="form-check-label" for="navbarIncluded">Include Navbar</label>
        </div>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="heroIncluded" checked>
          <label class="form-check-label" for="heroIncluded">Include Hero Section</label>
        </div>

        <hr>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="ecommerceIncluded">
          <label class="form-check-label" for="ecommerceIncluded">Include E-commerce Features</label>
        </div>

        <div id="ecommerceOptions" style="display:none;">
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="cartIncluded">
            <label class="form-check-label" for="cartIncluded">Include Cart</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="wishlistIncluded">
            <label class="form-check-label" for="wishlistIncluded">Include Wishlist</label>
          </div>
        </div>
      </div>

      <!-- Step 4: Theme Export & GitHub -->
      <div class="step" data-step="4">
        <div class="step-title mb-3">
          <h4 class="mb-0">Theme Export &amp; GitHub</h4>
          <span class="badge bg-secondary">Step 4</span>
        </div>

        <p class="text-muted">
          Choose a unique theme name. We’ll generate the Blogger theme XML and store it in the
          <strong>Themes</strong> sheet. If GitHub integration is enabled in the <strong>Settings</strong> sheet,
          you can also push the theme file to your repo.
        </p>

        <div class="mb-3">
          <label class="form-label" for="themeName">Theme Name</label>
          <input type="text" class="form-control" id="themeName" placeholder="My Awesome Theme">
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="pushGithub">
          <label class="form-check-label" for="pushGithub">
            Also push to GitHub (requires <code>github_*</code> settings)
          </label>
        </div>

        <button class="btn btn-success" id="generateThemeBtn">
          <i class="bi bi-cloud-arrow-down"></i>
          Generate &amp; Save Theme
        </button>

        <div class="small text-muted mt-2" id="themeStatus"></div>
      </div>

      <!-- Navigation -->
      <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-outline-secondary" id="prevBtn" disabled>Previous</button>
        <div>
          <button class="btn btn-secondary me-2" id="saveBtn">Save Settings</button>
          <button class="btn btn-primary" id="nextBtn">Next</button>
        </div>
      </div>

      <div id="status" class="mt-3 text-muted"></div>
    </div>

    <script>
      let currentStep = 1;
      const maxStep = 4;
      const state = {};

      function showStep(step) {
        document.querySelectorAll('.step').forEach(el => {
          el.classList.toggle('active', Number(el.dataset.step) === step);
        });
        document.getElementById('stepIndicator').textContent = 'Step ' + step + ' of ' + maxStep;
        document.getElementById('prevBtn').disabled = (step === 1);
        document.getElementById('nextBtn').textContent = (step === maxStep) ? 'Finish' : 'Next';
      }

      function collectState() {
        state.site_title = document.getElementById('siteTitle').value;
        state.logo_text = document.getElementById('logoText').value;
        state.primary_color = document.getElementById('primaryColor').value;
        state.language_mode = document.getElementById('languageMode').value;
        state.default_language = document.getElementById('defaultLanguage').value;
        state.currency_symbol = document.getElementById('currencySymbol').value;
        state.navbar_included = document.getElementById('navbarIncluded').checked ? 'yes' : 'no';
        state.hero_included = document.getElementById('heroIncluded').checked ? 'yes' : 'no';
        state.ecommerce_included = document.getElementById('ecommerceIncluded').checked ? 'yes' : 'no';
        state.cart_included = document.getElementById('cartIncluded').checked ? 'yes' : 'no';
        state.wishlist_included = document.getElementById('wishlistIncluded').checked ? 'yes' : 'no';
      }

      function saveSettings() {
        collectState();
        document.getElementById('status').textContent = 'Saving settings...';

        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.status === 'ok') {
              document.getElementById('status').textContent = 'Settings saved.';
            } else {
              document.getElementById('status').textContent = 'Error saving settings.';
            }
          })
          .withFailureHandler(function(err) {
            document.getElementById('status').textContent = 'Error: ' + err.message;
          })
          .saveSettings(JSON.stringify(state));
      }

      function generateThemeAndSave() {
        const nameInput = document.getElementById('themeName');
        const pushGithub = document.getElementById('pushGithub').checked;
        const statusEl = document.getElementById('themeStatus');
        const themeName = nameInput.value.trim();

        if (!themeName) {
          statusEl.textContent = 'Please enter a theme name.';
          statusEl.classList.remove('text-success');
          statusEl.classList.add('text-danger');
          return;
        }

        statusEl.textContent = 'Generating theme...';
        statusEl.classList.remove('text-danger', 'text-success');

        google.script.run
          .withSuccessHandler(function(res) {
            if (!res) {
              statusEl.textContent = 'Unknown error.';
              statusEl.classList.add('text-danger');
              return;
            }
            if (res.status === 'name-exists') {
              statusEl.textContent = res.message || 'Theme name already exists. Choose another name.';
              statusEl.classList.add('text-danger');
              return;
            }
            if (res.status === 'ok') {
              let msg = 'Theme "' + (res.themeName || themeName) + '" saved to Themes sheet.';
              if (res.github && res.github.status === 'ok') {
                msg += ' Also pushed to GitHub.';
              } else if (res.github && res.github.status === 'error') {
                msg += ' GitHub error: ' + (res.github.message || '');
              }
              statusEl.textContent = msg;
              statusEl.classList.add('text-success');
              return;
            }
            statusEl.textContent = res.message || 'Error generating theme.';
            statusEl.classList.add('text-danger');
          })
          .withFailureHandler(function(err) {
            statusEl.textContent = 'Error: ' + err.message;
            statusEl.classList.add('text-danger');
          })
          .withUserObject(null)
          .generateThemeAndSave(themeName, pushGithub);
      }

      document.getElementById('nextBtn').addEventListener('click', function() {
        if (currentStep < maxStep) {
          currentStep++;
          showStep(currentStep);
        } else {
          // On last step "Finish" just saves settings again.
          saveSettings();
        }
      });

      document.getElementById('prevBtn').addEventListener('click', function() {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      });

      document.getElementById('saveBtn').addEventListener('click', saveSettings);

      document.getElementById('ecommerceIncluded').addEventListener('change', function() {
        document.getElementById('ecommerceOptions').style.display = this.checked ? 'block' : 'none';
      });

      document.getElementById('generateThemeBtn').addEventListener('click', generateThemeAndSave);
    </script>
  </body>
</html>
