<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>Multipurpose Website Builder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
      body { padding: 1.5rem; }
      .step { display: none; }
      .step.active { display: block; }
      .step-indicator { font-weight: 600; margin-bottom: 1rem; }
      #themeXmlOutput {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: .8rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-3">Multipurpose Website Builder</h1>
      <p class="text-muted mb-4">
        Configure your site step by step. Your configuration will be stored in Google Sheets.
      </p>

      <div id="stepIndicator" class="step-indicator">Step 1 of 3</div>

      <!-- Step 1: Branding -->
      <div class="step active" data-step="1">
        <h4>Branding</h4>
        <div class="mb-3">
          <label class="form-label">Site Title</label>
          <input type="text" class="form-control" id="siteTitle">
        </div>
        <div class="mb-3">
          <label class="form-label">Logo Text</label>
          <input type="text" class="form-control" id="logoText">
        </div>
        <div class="mb-3">
          <label class="form-label">Primary Color (HEX)</label>
          <input type="text" class="form-control" id="primaryColor" placeholder="#0d6efd">
        </div>
      </div>

      <!-- Step 2: Language & Currency -->
      <div class="step" data-step="2">
        <h4>Language &amp; Currency</h4>
        <div class="mb-3">
          <label class="form-label">Language Mode</label>
          <select id="languageMode" class="form-select">
            <option value="single">Single language</option>
            <option value="multi">Multi-language</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Default Language</label>
          <select id="defaultLanguage" class="form-select">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="ar">العربية</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Currency Symbol</label>
          <input type="text" id="currencySymbol" class="form-control" placeholder="$">
        </div>
      </div>

      <!-- Step 3: Components & Ecommerce + Theme Name -->
      <div class="step" data-step="3">
        <h4>Components &amp; E-commerce</h4>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="navbarIncluded" checked>
          <label class="form-check-label" for="navbarIncluded">Include Navbar</label>
        </div>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="heroIncluded" checked>
          <label class="form-check-label" for="heroIncluded">Include Hero Section</label>
        </div>

        <hr>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="ecommerceIncluded">
          <label class="form-check-label" for="ecommerceIncluded">Include E-commerce Features</label>
        </div>

        <div id="ecommerceOptions" style="display:none;">
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="cartIncluded">
            <label class="form-check-label" for="cartIncluded">Include Cart</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="wishlistIncluded">
            <label class="form-check-label" for="wishlistIncluded">Include Wishlist</label>
          </div>
        </div>

        <hr class="my-4">

        <h5>Theme Export</h5>
        <div class="mb-3">
          <label class="form-label">Theme Name</label>
          <input type="text" class="form-control" id="themeName" placeholder="my-awesome-theme">
          <div class="form-text">
            Theme name must be unique. If it’s already used, you’ll be asked to choose another name.
          </div>
        </div>

      </div>

      <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-outline-secondary" id="prevBtn" disabled>Previous</button>
        <div class="d-flex gap-2">
          <button class="btn btn-secondary" id="saveBtn">Save</button>
          <button class="btn btn-outline-primary" id="generateBtn" type="button">
            <i class="bi bi-file-code me-1"></i> Generate Theme XML
          </button>
          <button class="btn btn-primary" id="nextBtn">Next</button>
        </div>
      </div>

      <div id="status" class="mt-3 text-muted"></div>

      <div class="mt-4">
        <label for="themeXmlOutput" class="form-label">Generated theme.xml (copy &amp; paste into Blogger):</label>
        <textarea id="themeXmlOutput" class="form-control" rows="12" readonly></textarea>
      </div>
    </div>

    <script>
      let currentStep = 1;
      const maxStep = 3;
      const state = {};

      function showStep(step) {
        document.querySelectorAll('.step').forEach(el => {
          el.classList.toggle('active', Number(el.dataset.step) === step);
        });
        document.getElementById('stepIndicator').textContent = 'Step ' + step + ' of ' + maxStep;
        document.getElementById('prevBtn').disabled = (step === 1);
        document.getElementById('nextBtn').textContent = (step === maxStep) ? 'Finish' : 'Next';
      }

      function collectState() {
        state.site_title = document.getElementById('siteTitle').value;
        state.logo_text = document.getElementById('logoText').value;
        state.primary_color = document.getElementById('primaryColor').value;
        state.language_mode = document.getElementById('languageMode').value;
        state.default_language = document.getElementById('defaultLanguage').value;
        state.currency_symbol = document.getElementById('currencySymbol').value;
        state.navbar_included = document.getElementById('navbarIncluded').checked ? 'yes' : 'no';
        state.hero_included = document.getElementById('heroIncluded').checked ? 'yes' : 'no';
        state.ecommerce_included = document.getElementById('ecommerceIncluded').checked ? 'yes' : 'no';
        state.cart_included = document.getElementById('cartIncluded').checked ? 'yes' : 'no';
        state.wishlist_included = document.getElementById('wishlistIncluded').checked ? 'yes' : 'no';
      }

      function saveSettings() {
        collectState();
        document.getElementById('status').textContent = 'Saving...';

        google.script.run
          .withSuccessHandler(function(res) {
            document.getElementById('status').textContent = 'Saved.';
          })
          .withFailureHandler(function(err) {
            document.getElementById('status').textContent = 'Error: ' + err.message;
          })
          .saveSettings(JSON.stringify(state));
      }

      function generateThemeXml() {
        const themeNameInput = document.getElementById('themeName');
        const name = (themeNameInput.value || '').trim();
        if (!name) {
          alert('Please enter a theme name.');
          themeNameInput.focus();
          return;
        }

        // Save latest settings before generation
        collectState();

        document.getElementById('status').textContent =
          'Generating theme "' + name + '" (checking name availability)...';

        google.script.run
          .withSuccessHandler(function(res) {
            if (!res || res.status !== 'ok') {
              if (res && res.code === 'NAME_TAKEN') {
                alert('This theme name is already used. Please choose another name.');
                document.getElementById('status').textContent = 'Theme name already used.';
              } else {
                alert('Error generating theme.');
                document.getElementById('status').textContent = 'Error generating theme.';
              }
              return;
            }
            document.getElementById('themeXmlOutput').value = res.themeXml || '';
            document.getElementById('status').textContent =
              'Theme generated as "' + (res.themeName || name) + '". Copy the XML into Blogger.';
          })
          .withFailureHandler(function(err) {
            alert('Error: ' + err.message);
            document.getElementById('status').textContent = 'Error generating theme.';
          })
          .generateThemeNamed(name);
      }

      document.getElementById('nextBtn').addEventListener('click', function() {
        if (currentStep < maxStep) {
          currentStep++;
          showStep(currentStep);
        } else {
          saveSettings();
        }
      });

      document.getElementById('prevBtn').addEventListener('click', function() {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      });

      document.getElementById('saveBtn').addEventListener('click', saveSettings);
      document.getElementById('generateBtn').addEventListener('click', generateThemeXml);

      document.getElementById('ecommerceIncluded').addEventListener('change', function() {
        document.getElementById('ecommerceOptions').style.display = this.checked ? 'block' : 'none';
      });

      // TODO: Load existing settings on startup via google.script.run.getSettings().
    </script>
  </body>
</html>
