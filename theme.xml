<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:defaultwidgetversion='2' b:layoutsVersion='3' b:responsive='true' b:version='2' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
  <meta content='width=device-width, initial-scale=1.0' name='viewport'/>
  <title><data:blog.pageTitle/></title>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'/>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css' rel='stylesheet'/>
  <b:skin><![CDATA[
    :root { --primary: #01fe2b; --bg: #0b0b0b; --card: #151515; --text: #ffffff; }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; }
    .navbar { background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 1000; }
    #hero { background: linear-gradient(180deg, var(--primary), #000); padding: 60px 20px; text-align: center; border-radius: 0 0 40px 40px; }
    .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .menu-item { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid #333; }
    .card-img { width: 100%; height: 200px; object-fit: cover; }
    .price { color: var(--primary); font-weight: bold; font-size: 1.2rem; }
    .cart-drawer { position: fixed; top: 0; right: -400px; width: 100%; max-width: 400px; height: 100vh; background: var(--card); z-index: 2000; transition: 0.4s; border-left: 1px solid var(--primary); }
    .cart-drawer.open { right: 0; }
    #Blog1 { display: none !important; }
  ]]></b:skin>
</head>
<body>
  <div class="cart-drawer" id="cartDrawer">
    <div class="p-4 bg-dark d-flex justify-content-between">
      <h4 class="m-0">My Selection</h4>
      <button class="btn-close btn-close-white" onclick="toggleCart()"></button>
    </div>
    <div class="p-4" id="cartItems"></div>
    <div class="p-4 border-top border-secondary mt-auto">
      <div class="d-flex justify-content-between mb-3 fw-bold fs-5">
        <span>Total:</span><span id="cartTotal">0 DH</span>
      </div>
      <button class="btn btn-primary w-100 fw-bold py-3" onclick="checkout()">CHECKOUT TO WHATSAPP</button>
    </div>
  </div>

  <nav class="navbar navbar-dark px-4">
    <a class="navbar-brand fw-bold" href="#">Event Sushi</a>
    <div onclick="toggleCart()" style="cursor:pointer" class="position-relative">
      <i class="bi bi-bag-check fs-3 text-primary"></i>
      <span id="cartCount" class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle">0</span>
    </div>
  </nav>

  <header id="hero">
    <h1 class="display-4 fw-bold">Event Sushi</h1>
    <p class="lead opacity-75">Fresh. Authentic.</p>
  </header>

  <div id="shopContent" class="menu-grid">
    <div class="text-center w-100 py-5" id="loader">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Connecting to Kitchen...</p>
    </div>
  </div>

  <div style="display:none"><b:section id='main'><b:widget id='Blog1' type='Blog'/></b:section></div>

  <script>
  //<![CDATA[
    const CONFIG = { baseUrl: 'https://[[BASE_URL]]', whatsapp: '212664070513' };
    let allProducts = [];
    let cart = [];

    function fetchProducts() {
      const script = document.createElement('script');
      script.src = CONFIG.baseUrl + '/feeds/posts/default?alt=json&amp;max-results=50&amp;callback=handleFeed&amp;t=' + new Date().getTime();
      script.onerror = () => {
        document.getElementById('loader').innerHTML = '<div class="alert alert-danger">Error: Blogger Feed is not accessible. Check Settings > Site Feed > Full.</div>';
      };
      document.body.appendChild(script);
    }

    window.handleFeed = function(json) {
      const entries = json.feed.entry || [];
      const container = document.getElementById('shopContent');
      
      if (entries.length === 0) {
        container.innerHTML = "No items found in feed.";
        return;
      }

      allProducts = entries.map(e => {
        let price = 0;
        if (e.category) {
          e.category.forEach(c => {
            const term = c.term.toLowerCase();
            if (term.includes('price-')) price = term.split('-')[1];
          });
        }
        const content = e.content ? e.content.$t : '';
        const imgMatch = content.match(/<img[^>]+src="([^">]+)"/);
        return {
          id: e.id.$t.split('post-')[1],
          title: e.title.$t,
          price: parseFloat(price) || 0,
          image: imgMatch ? imgMatch[1] : (e.media$thumbnail ? e.media$thumbnail.url.replace('s72-c', 's600') : 'https://via.placeholder.com/300')
        };
      });
      renderProducts(allProducts);
    };

    function renderProducts(items) {
      document.getElementById('shopContent').innerHTML = items.map(p => `
        <div class="menu-item">
          <img src="${p.image}" class="card-img" />
          <div class="p-3">
            <h6 class="fw-bold">${p.title}</h6>
            <div class="price mb-3">${p.price} DH</div>
            <button class="btn btn-outline-primary w-100" onclick="addToCart('${p.id}')">Add to Selection</button>
          </div>
        </div>`).join('');
    }

    window.addToCart = function(id) {
      const p = allProducts.find(x => x.id === id);
      const existing = cart.find(x => x.id === id);
      if (existing) existing.qty++;
      else cart.push({...p, qty: 1});
      updateUI();
      document.getElementById('cartDrawer').classList.add('open');
    };

    function updateUI() {
      document.getElementById('cartCount').innerText = cart.reduce((a, b) => a + b.qty, 0);
      const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
      document.getElementById('cartTotal').innerText = total + " DH";
      document.getElementById('cartItems').innerHTML = cart.map(i => `
        <div class="d-flex justify-content-between mb-2 small border-bottom border-secondary pb-1">
          <span>${i.qty}x ${i.title}</span>
          <span>${i.price * i.qty} DH</span>
        </div>`).join('');
    }

    window.toggleCart = () => document.getElementById('cartDrawer').classList.toggle('open');

    window.checkout = function() {
      if (!cart.length) return;
      const summary = cart.map(i => `${i.qty}x ${i.title}`).join('%0A');
      const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
      const msg = `ðŸ± *NEW ORDER*%0A------------------%0A${summary}%0A------------------%0A*Total:* ${total} DH`;
      window.open(`https://wa.me/${CONFIG.whatsapp}?text=${msg}`, '_blank');
    };

    fetchProducts();
  //]]>
  </script>
</body>
</html>