<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:responsive='true' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
  <meta charset='UTF-8'/>
  <meta content='width=device-width, initial-scale=1.0' name='viewport'/>
  <title><data:blog.pageTitle/></title>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'/>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css' rel='stylesheet'/>
  <b:skin><![CDATA[ 
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    #app-header { padding: 80px 0 40px; color: white; text-align: center; margin-bottom: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .matrix-bar { max-width: 400px; margin: -25px auto 30px; background: white; padding: 10px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; align-items: center; }
    .matrix-input { border: none; outline: none; flex-grow: 1; padding: 5px 15px; font-size: 1.1rem; }
    .matrix-btn { border-radius: 50px; padding: 8px 25px; }
    .post-card { background: white; border: none; border-radius: 12px; overflow: hidden; transition: transform 0.3s; height: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .post-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .post-img { height: 200px; width: 100%; object-fit: cover; }
    .post-body { padding: 20px; }
    .loader-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  ]]></b:skin>
</head>
<body>

  <!-- Loader -->
  <div id="siteLoader" class="loader-overlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <p class="mt-3 text-muted">Building your site...</p>
  </div>

  <!-- Header (Dynamic Color) -->
  <header id="app-header" style="background-color: #333;">
    <div class="container">
      <h1 class="display-4 fw-bold" id="app-title">Loading...</h1>
      <p class="lead opacity-75" id="app-subtitle">...</p>
    </div>
  </header>

  <!-- Matrix Navigation -->
  <div class="container">
    <div class="matrix-bar">
      <span class="ms-2 text-muted"><i class="bi bi-grid-3x3-gap-fill"></i></span>
      <input type="text" id="matrixInput" class="matrix-input" placeholder="Matrix Code (e.g. 1-2)" />
      <button class="btn btn-primary matrix-btn" id="matrixBtn" onclick="runMatrix()">Go</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="container mb-5">
    <div id="content-area" class="row g-4">
      <!-- Posts injected here -->
    </div>
  </div>

  <!-- Required Blogger Widget (Hidden) -->
  <b:section class='main' id='main' maxwidgets='1' showaddelement='no'>
    <b:widget id='HTML1' locked='true' title='App' type='HTML' version='1'>
      <b:widget-settings><b:widget-setting name='content'/></b:widget-settings>
      <b:includable id='main'></b:includable>
    </b:widget>
  </b:section>

  <script>
  //<![CDATA[
    // ** IMPORTANT: PASTE YOUR NEW WEB APP URL HERE **
    const API_URL = 'https://script.google.com/macros/s/AKfycbxBOuXmYcOpeijxpBMwEV5clzoUg1zYG6hwQ93AFj5FRjXE3rHPR5fdauhInRh4uB00BA/exec';

    let siteConfig = {};

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Fetch Configuration
        fetchJsonp(API_URL + '?action=getConfig', (config) => {
            siteConfig = config;
            applyTheme(config);
            // 2. Fetch Content
            fetchJsonp(API_URL + '?action=getData&type=' + encodeURIComponent(config.type), renderPosts);
        });

        // Matrix Input Enter Key
        document.getElementById('matrixInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') runMatrix();
        });
    });

    function applyTheme(config) {
        document.getElementById('app-title').innerText = config.title;
        document.getElementById('app-subtitle').innerText = config.type;
        document.getElementById('app-header').style.backgroundColor = config.color;
        document.getElementById('matrixBtn').style.backgroundColor = config.color;
        document.getElementById('matrixBtn').style.borderColor = config.color;
        document.title = config.title;
    }

    function renderPosts(posts) {
        const grid = document.getElementById('content-area');
        document.getElementById('siteLoader').style.display = 'none'; // Hide loader
        
        if (!posts || posts.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center p-5"><h3>No posts found.</h3><p class="text-muted">Add posts to your Blogger backend.</p></div>';
            return;
        }

        grid.innerHTML = posts.map(p => `
            <div class="col-md-4 col-sm-6">
                <div class="post-card">
                    <img src="${p.image}" class="post-img" alt="${p.title}">
                    <div class="post-body">
                        <h5 class="card-title">${p.title}</h5>
                        <p class="card-text small text-muted">${p.excerpt}</p>
                        <button class="btn btn-sm btn-outline-secondary mt-2">Read More</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function runMatrix() {
        const code = document.getElementById('matrixInput').value;
        alert("Matrix Code " + code + " triggered! (Add specific logic here)");
    }

    // Simple JSONP implementation
    function fetchJsonp(url, callback) {
        const callbackName = 'jsonp_cb_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
            delete window[callbackName];
            document.body.removeChild(script);
            callback(data);
        };
        const script = document.createElement('script');
        script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
        document.body.appendChild(script);
    }
  //]]>
  </script>
</body>
</html>
