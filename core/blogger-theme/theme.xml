<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:responsive='true' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>

<head>
  <meta charset='UTF-8'/>
  <meta content='width=device-width, initial-scale=1.0' name='viewport'/>
  <title><data:blog.pageTitle/></title>

  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'/>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css' rel='stylesheet'/>
  <link href='https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&amp;display=swap' rel='stylesheet'/>

  <b:skin><![CDATA[
    body { background-color:#f5f5f5; }
  ]]></b:skin>
</head>

<body>

  <b:section class='main' id='main' maxwidgets='1' showaddelement='no'>
    <b:widget id='HTML1' locked='true' title='SPA Body' type='HTML' version='1'>
      <b:widget-settings>
        <b:widget-setting name='content'/>
      </b:widget-settings>
      <b:includable id='main'>

        <!-- Matrix Code Input (New) -->
        <div class='container mt-4'>
           <div class='input-group mb-3' style='max-width: 400px; margin: 0 auto;'>
             <span class='input-group-text bg-primary text-white'><i class="bi bi-grid-3x3-gap-fill"></i></span>
             <input type='text' class='form-control' id='matrixCodeInput' placeholder='Enter Matrix Code (e.g. 12 or 1-2)'>
             <button class='btn btn-primary' type='button' onclick='applyMatrixCode()'>Go</button>
           </div>
        </div>

        <!-- Website Type Selector -->
        <div class='container website-type-selector'>
          <div class='selector-group'>
            <div>
              <label class='selector-label'>Website Type:</label>
              <!-- Select options will be populated via JS -->
              <select class='selector-select' id='websiteTypeSelector'>
                <option value="" disabled selected>Loading categories...</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Subcategory Display -->
        <div class='container mb-4' id='subcategoryContainer'></div>

        <!-- Loading Container -->
        <div class='loading-container' id='loadingContainer' style='display:flex;'>
          <div class='loading-spinner'/>
          <div class='loading-text'>Loading content...</div>
        </div>

        <!-- Main Content -->
        <section class='container' id='mainContent' style='display:none;'>
          <!-- Content will be loaded here dynamically -->
        </section>

      </b:includable>
    </b:widget>
  </b:section>

  <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js'/>
  <script>
    // Configuration
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxBOuXmYcOpeijxpBMwEV5clzoUg1zYG6hwQ93AFj5FRjXE3rHPR5fdauhInRh4uB00BA/exec';
    let currentWebsiteType = '';
    let websiteTypesConfig = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      fetchWebsiteTypes();
      
      // Allow pressing Enter in matrix input
      document.getElementById('matrixCodeInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          applyMatrixCode();
        }
      });
    });
    
    // --- MATRIX CODE LOGIC ---
    function applyMatrixCode() {
       const rawInput = document.getElementById('matrixCodeInput').value;
       // Replace any separators with a standard separator or empty string
       // If input is "12", digit 1 is cat, digit 2 is sub (for <10 cats).
       // If input is "1-2", clear intent.
       
       let cleanInput = rawInput.replace(/[^0-9\-\.\s]/g, '');
       if(!cleanInput) return;
       
       let catIndex = -1;
       let subIndex = -1;
       
       // Check for explicit separators
       if (cleanInput.match(/[\-\.\s]/)) {
           const parts = cleanInput.split(/[\-\.\s]+/);
           catIndex = parseInt(parts[0]) - 1; // 1-based to 0-based
           if(parts[1]) subIndex = parseInt(parts[1]) - 1;
       } else {
           // Continuous string logic
           // If length is 2, assume single digit category. E.g. "12" = Cat 1, Sub 2.
           // If length is 3+, it is ambiguous without separator, but let's assume first digit is category for now unless >9 categories exist.
           // Actually, standard matrix practice: "12" = 1, 2.
           if (cleanInput.length > 0) {
              catIndex = parseInt(cleanInput.charAt(0)) - 1;
              if (cleanInput.length > 1) {
                 subIndex = parseInt(cleanInput.charAt(1)) - 1;
              }
           }
       }
       
       // Validate and Switch
       if (websiteTypesConfig[catIndex]) {
           const typeName = websiteTypesConfig[catIndex].name;
           
           // Update Dropdown
           const selector = document.getElementById('websiteTypeSelector');
           selector.value = typeName;
           
           // Trigger change
           currentWebsiteType = typeName;
           updateSubcategories(currentWebsiteType);
           fetchData();
           
           // Handle Subcategory highlighting (optional visual feedback)
           if(subIndex > -1 && websiteTypesConfig[catIndex].subcategories[subIndex]) {
               // Wait for subcategories to render then highlight
               setTimeout(() => {
                  const badges = document.querySelectorAll('#subcategoryContainer .badge');
                  if(badges[subIndex]) {
                      badges[subIndex].classList.remove('bg-secondary');
                      badges[subIndex].classList.add('bg-primary'); // Highlight
                  }
               }, 100);
           }
           
           // Clear input
           document.getElementById('matrixCodeInput').value = '';
       } else {
           alert('Invalid Matrix Code');
       }
    }

    // Fetch website types
    function fetchWebsiteTypes() {
      const script = document.createElement('script');
      script.src = WEB_APP_URL + '?action=getWebsiteTypes&amp;callback=handleWebsiteTypes';
      document.body.appendChild(script);
    }

    // Handle website types response
    function handleWebsiteTypes(data) {
      websiteTypesConfig = data.website_types;
      const selector = document.getElementById('websiteTypeSelector');
      selector.innerHTML = ''; // Clear loading message
      
      // Populate dropdown with index numbers [1] Name
      websiteTypesConfig.forEach((type, index) => {
        const option = document.createElement('option');
        option.value = type.name;
        option.textContent = `[${index + 1}] ${type.name}`; // Show Matrix Index
        selector.appendChild(option);
      });
      
      // Set default and fetch
      currentWebsiteType = websiteTypesConfig[0].name;
      updateSubcategories(currentWebsiteType);
      fetchData();
    }
    
    function updateSubcategories(typeName) {
       const config = websiteTypesConfig.find(t => t.name === typeName);
       const container = document.getElementById('subcategoryContainer');
       if(config && config.subcategories) {
         // Show subcategory with its index
         container.innerHTML = config.subcategories.map((sub, idx) => 
           `<span class="badge bg-secondary me-1 mb-1">[${idx + 1}] ${sub}</span>`
         ).join('');
       } else {
         container.innerHTML = '';
       }
    }

    // Fetch data for current website type
    function fetchData() {
      document.getElementById('loadingContainer').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
      
      const oldScript = document.getElementById('jsonp-data-script');
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.id = 'jsonp-data-script';
      script.src = WEB_APP_URL + '?action=getData&websiteType=' + encodeURIComponent(currentWebsiteType) + '&callback=handleDataResponse';
      document.body.appendChild(script);
    }

    // Handle data response
    function handleDataResponse(data) {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      generateGenericHTML(data);
    }

    function generateGenericHTML(posts) {
      let html = '<div class="blog-container">';
      posts.forEach(function(post) {
        html += '<article class="blog-post">';
        if(post.imageUrl) html += '<img src="' + post.imageUrl + '" style="max-height:200px; width:100%; object-fit:cover; border-radius:4px;">';
        html += '<h3 class="mt-2">' + post.title + '</h3>';
        html += '<p>' + post.excerpt + '</p>';
        html += '<small class="text-muted">' + post.publishedDate + '</small>';
        html += '</article>';
      });
      html += '</div>';
      document.getElementById('mainContent').innerHTML = html;
    }

    // Website type selector change
    document.getElementById('websiteTypeSelector').addEventListener('change', function() {
      currentWebsiteType = this.value;
      updateSubcategories(currentWebsiteType);
      fetchData();
    });
  </script>
  <style>
    .website-type-selector { margin: 20px 0; }
    .selector-group { display: flex; gap: 15px; align-items: center; justify-content: center; }
    .selector-label { font-weight: 600; }
    .selector-select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; max-width: 300px; }
    .loading-container { display: flex; justify-content: center; align-items: center; padding: 50px; }
    .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .blog-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
    .blog-post { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .blog-post:hover { transform: translateY(-5px); }
  </style>

</body>
</html>
