<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:responsive='true' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
  <meta charset='UTF-8'/>
  <meta content='width=device-width, initial-scale=1.0' name='viewport'/>
  <title><data:blog.pageTitle/></title>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'/>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css' rel='stylesheet'/>
  <!-- DYNAMIC CSS VARIABLES -->
  <style id="dynamic-styles">
    :root {
      --primary-color: {{SITE_COLOR}};
    }
  </style>
  <b:skin><![CDATA[ 
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    #app-header { padding: 80px 0 40px; background-color: var(--primary-color, #333); color: white; text-align: center; margin-bottom: 40px; transition: background 0.3s; }
    .matrix-container { max-width: 400px; margin: -30px auto 30px; }
    .matrix-input-group { background: white; padding: 8px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; }
    .matrix-input { border: none; outline: none; flex-grow: 1; padding: 5px 15px; font-size: 1.1rem; }
    .btn-go { border-radius: 50px; padding: 8px 25px; background: var(--primary-color, #333); color: white; border: none; }
    .post-card { background: white; border-radius: 12px; overflow: hidden; height: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .post-card:hover { transform: translateY(-5px); }
    .post-img { height: 200px; width: 100%; object-fit: cover; }
    .post-body { padding: 20px; }
    .badge-sub { cursor: pointer; transition: 0.2s; }
    .badge-sub:hover { opacity: 0.8; }
    .loader-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    
    /* Feature Toggles CSS */
    .feature-hidden { display: none !important; }
  ]]></b:skin>
</head>
<body>

  <!-- Loader -->
  <div id="siteLoader" class="loader-overlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <p class="mt-3 text-muted">Building your site...</p>
  </div>

  <!-- Header -->
  <header id="app-header">
    <div class="container">
      <!-- Default Title injected from Builder -->
      <h1 class="display-4 fw-bold" id="app-title">{{SITE_TITLE}}</h1>
      <p class="lead opacity-75" id="app-subtitle">{{SITE_TYPE}}</p>
    </div>
  </header>

  <!-- Matrix Navigation -->
  <div class="container matrix-container {{MATRIX_CLASS}}">
    <div class="matrix-input-group">
      <span class="ms-2 align-self-center text-muted"><i class="bi bi-grid-3x3-gap-fill"></i></span>
      <input type="text" id="matrixInput" class="matrix-input" placeholder="Matrix Code (e.g. 1 or 2)" />
      <button class="btn-go" id="matrixBtn" onclick="runMatrix()">Go</button>
    </div>
  </div>

  <!-- Subcategories Display -->
  <div class="container text-center mb-4">
     <div id="subcat-badges"></div>
  </div>

  <!-- Content -->
  <div class="container mb-5">
    <div id="content-area" class="row g-4"></div>
  </div>

  <!-- Required Widget -->
  <b:section class='main' id='main' maxwidgets='1' showaddelement='no'>
    <b:widget id='HTML1' locked='true' title='App' type='HTML' version='1'>
      <b:widget-settings><b:widget-setting name='content'/></b:widget-settings>
      <b:includable id='main'></b:includable>
    </b:widget>
  </b:section>

  <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js'></script>
  <script>
  //<![CDATA[
    // ** AUTO-INJECTED URL FROM BUILDER **
    const WEB_APP_URL = '{{WEB_APP_URL}}';

    let siteConfig = {};
    let allTypes = [];
    let allPosts = [];
    let currentTypeConfig = null;

    document.addEventListener('DOMContentLoaded', () => {
        
        // Load Data
        const p1 = new Promise(r => fetchJsonp(WEB_APP_URL + '?action=getConfig', r));
        const p2 = new Promise(r => fetchJsonp(WEB_APP_URL + '?action=getWebsiteTypes', r));
        const p3 = new Promise(r => fetchJsonp(WEB_APP_URL + '?action=getData', r));

        Promise.all([p1, p2, p3]).then(([configData, typesData, postsData]) => {
            
            siteConfig = configData || { title: "{{SITE_TITLE}}", type: "{{SITE_TYPE}}", color: "{{SITE_COLOR}}" };
            allTypes = typesData.website_types || [];
            allPosts = postsData || [];

            const typeName = siteConfig.type || "{{SITE_TYPE}}";
            currentTypeConfig = allTypes.find(t => t.name === typeName);

            applyTheme();
            renderPosts(allPosts);

            document.getElementById('siteLoader').style.display = 'none';
        });

        const input = document.getElementById('matrixInput');
        if(input) input.addEventListener('keypress', (e) => { if(e.key === 'Enter') runMatrix(); });
    });

    function applyTheme() {
        document.getElementById('app-title').innerText = siteConfig.title;
        document.getElementById('app-subtitle').innerText = siteConfig.type;
        
        const color = siteConfig.color || '#333';
        document.documentElement.style.setProperty('--primary-color', color);
        
        // Feature Toggles
        if(siteConfig.featMatrix === 'false') document.querySelector('.matrix-container').style.display = 'none';
        
        // Render Subcategory Badges
        if (currentTypeConfig && currentTypeConfig.subcategories) {
            const html = currentTypeConfig.subcategories.map((sub, i) => 
                `<span class="badge bg-secondary badge-sub me-1 mb-1" onclick="filterByMatrix(${i+1})">[${i+1}] ${sub}</span>`
            ).join('');
            document.getElementById('subcat-badges').innerHTML = html;
        }
    }

    function runMatrix() {
        const val = document.getElementById('matrixInput').value.trim();
        const index = parseInt(val);
        if (index && index > 0) {
            filterByMatrix(index);
        } else {
            alert("Please enter a valid number");
        }
    }

    function filterByMatrix(index) {
        if (!currentTypeConfig || !currentTypeConfig.subcategories) return;
        const subName = currentTypeConfig.subcategories[index - 1];
        if (!subName) { alert("Code not found."); return; }

        const filtered = allPosts.filter(p => {
            if (!p.labels) return false;
            return p.labels.some(l => l.toLowerCase() === subName.toLowerCase());
        });

        renderPosts(filtered);
        
        const badges = document.querySelectorAll('.badge-sub');
        badges.forEach(b => { b.classList.remove('bg-primary'); b.classList.add('bg-secondary'); });
        if(badges[index-1]) { badges[index-1].classList.remove('bg-secondary'); badges[index-1].classList.add('bg-primary'); }

        document.getElementById('app-subtitle').innerHTML = `Filtering: <strong>${subName}</strong> <a href="#" onclick="resetFilter(); return false;" class="text-white small">(Reset)</a>`;
    }
    
    function resetFilter() {
        renderPosts(allPosts);
        document.getElementById('app-subtitle').innerText = siteConfig.type;
        document.querySelectorAll('.badge-sub').forEach(b => { b.classList.remove('bg-primary'); b.classList.add('bg-secondary'); });
    }

    function renderPosts(posts) {
        const grid = document.getElementById('content-area');
        if (!posts || posts.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center p-5"><h3>No results.</h3><p class="text-muted">Ensure posts have Labels matching: ' + (currentTypeConfig ? currentTypeConfig.subcategories.join(', ') : '') + '</p></div>';
            return;
        }

        grid.innerHTML = posts.map(p => `
            <div class="col-md-4 col-sm-6">
                <div class="post-card">
                    <img src="${p.image}" class="post-img" alt="${p.title}">
                    <div class="post-body">
                        <h5 class="card-title">${p.title}</h5>
                        <p class="card-text small text-muted">${p.excerpt}</p>
                        <div class="mt-2">
                           ${p.labels.map(l => `<span class="badge bg-light text-dark border me-1">${l}</span>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function fetchJsonp(url, callback) {
        const callbackName = 'jsonp_cb_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
            delete window[callbackName];
            document.body.removeChild(script);
            callback(data);
        };
        const script = document.createElement('script');
        script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
        script.onerror = () => { console.error("JSONP Error"); delete window[callbackName]; callback(null); };
        document.body.appendChild(script);
    }
  //]]>
  </script>
</body>
</html>
