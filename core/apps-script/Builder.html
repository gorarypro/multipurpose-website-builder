<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Website Builder Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f0f2f5; font-family: sans-serif; padding: 20px; }
      .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
      .preview-box { background: #fff; border: 2px dashed #ddd; border-radius: 8px; padding: 15px; margin-top: 10px; min-height: 60px; }
    </style>
  </head>
  <body>
    <div class="card p-4">
      <h2 class="text-center mb-4">üõ†Ô∏è Website Builder Admin</h2>
      
      <form id="builderForm">
        <!-- 1. Identity -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Website Title</label>
            <input type="text" class="form-control" id="siteTitle" placeholder="My Awesome Site" value="My New Website">
          </div>
          <div class="col-md-6">
            <label class="form-label">Primary Color</label>
            <input type="color" class="form-control form-control-color w-100" id="siteColor" value="#0d6efd">
          </div>
        </div>

        <!-- 2. Category -->
        <div class="mb-3">
          <label class="form-label">Select Website Category</label>
          <select class="form-select" id="websiteType" onchange="updatePreview()">
            <option value="" disabled selected>Loading categories...</option>
          </select>
          <div id="subcatPreview" class="preview-box text-muted text-center small mt-2">
            Select a category to see Matrix codes...
          </div>
        </div>

        <!-- 3. Publish -->
        <div class="d-grid">
          <button type="button" class="btn btn-primary btn-lg" onclick="saveConfig()">
            Publish Changes to Live Site
          </button>
        </div>
        <div id="status" class="mt-3 text-center"></div>
      </form>
    </div>

    <script>
      // Fetch categories from Code.gs on load
      google.script.run.withSuccessHandler(populateTypes).getWebsiteTypes();

      let allTypes = [];

      function populateTypes(data) {
        allTypes = data.website_types;
        const select = document.getElementById('websiteType');
        select.innerHTML = '<option value="" disabled selected>Choose a category...</option>';
        
        allTypes.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = t.name;
          select.appendChild(opt);
        });
      }

      function updatePreview() {
        const typeName = document.getElementById('websiteType').value;
        const config = allTypes.find(t => t.name === typeName);
        if (config) {
          document.getElementById('subcatPreview').innerHTML = config.subcategories.map((sub, i) => 
            `<span class="badge bg-secondary me-1">[${i+1}] ${sub}</span>`
          ).join(' ');
          document.getElementById('siteColor').value = config.color || '#0d6efd';
        }
      }

      function saveConfig() {
        const btn = document.querySelector('button');
        btn.disabled = true;
        btn.innerText = "Publishing...";
        
        const config = {
          type: document.getElementById('websiteType').value,
          title: document.getElementById('siteTitle').value,
          color: document.getElementById('siteColor').value
        };

        if(!config.type) { alert("Select a category"); btn.disabled=false; return; }

        google.script.run.withSuccessHandler(() => {
           document.getElementById('status').innerHTML = '<div class="alert alert-success">‚úÖ Saved! Refresh your Blogger site.</div>';
           btn.disabled = false; 
           btn.innerText = "Publish Changes";
        }).saveConfigToSheet(config);
      }
    </script>
  </body>
</html>
