<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Website Builder Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f0f2f5; font-family: sans-serif; padding: 20px; }
      .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
    </style>
  </head>
  <body>
    <div class="card p-4">
      <div class="text-center mb-4">
        <h2>üõ†Ô∏è Website Builder Admin</h2>
        <p class="text-muted">Configure and Download your Theme</p>
      </div>
      
      <form id="builderForm">
        <!-- Identity -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Website Title</label>
            <input type="text" class="form-control" id="siteTitle" value="My New Website">
          </div>
          <div class="col-md-6">
            <label class="form-label">Primary Color</label>
            <input type="color" class="form-control form-control-color w-100" id="siteColor" value="#0d6efd">
          </div>
        </div>

        <!-- Category -->
        <div class="mb-3">
          <label class="form-label">Select Category</label>
          <select class="form-select" id="websiteType" onchange="updatePreview()">
            <option value="" disabled selected>Loading...</option>
          </select>
        </div>
        
        <div class="mb-4 form-check form-switch">
            <input class="form-check-input" type="checkbox" id="featMatrix" checked>
            <label class="form-check-label" for="featMatrix">Enable Matrix Navigation</label>
        </div>

        <!-- Actions -->
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-success btn-lg" onclick="saveConfig()">
            üíæ Save Settings
          </button>
          <button type="button" class="btn btn-dark btn-lg" onclick="downloadTheme()">
            üì• Download Blogger Theme
          </button>
        </div>
        <div id="status" class="mt-3 text-center"></div>
      </form>
    </div>

    <script>
      let allTypes = [];

      // Load categories
      google.script.run.withSuccessHandler(data => {
        allTypes = data.website_types;
        const select = document.getElementById('websiteType');
        select.innerHTML = '<option value="" disabled selected>Choose a category...</option>';
        allTypes.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = t.name;
          select.appendChild(opt);
        });
        
        // Load saved config
        google.script.run.withSuccessHandler(config => {
           if(config.title) document.getElementById('siteTitle').value = config.title;
           if(config.color) document.getElementById('siteColor').value = config.color;
           if(config.type) {
              select.value = config.type;
              updatePreview();
           }
        }).getSavedConfig();
        
      }).getWebsiteTypes();

      function updatePreview() {
        const typeName = document.getElementById('websiteType').value;
        const config = allTypes.find(t => t.name === typeName);
        if(config) document.getElementById('siteColor').value = config.color || '#000000';
      }

      function saveConfig() {
        const btn = document.querySelector('.btn-success');
        btn.disabled = true;
        btn.innerText = "Saving...";
        
        const config = {
          type: document.getElementById('websiteType').value,
          title: document.getElementById('siteTitle').value,
          color: document.getElementById('siteColor').value,
          featMatrix: document.getElementById('featMatrix').checked.toString()
        };

        google.script.run.withSuccessHandler(() => {
           document.getElementById('status').innerHTML = '<div class="alert alert-success">Settings Saved!</div>';
           btn.disabled = false; 
           btn.innerText = "üíæ Save Settings";
        }).saveConfigToSheet(config);
      }

      function downloadTheme() {
        const btn = document.querySelector('.btn-dark');
        btn.disabled = true;
        btn.innerText = "Generating XML...";
        
        // Pass current UI values directly to generator so download works even without saving
        const config = {
          type: document.getElementById('websiteType').value || "Home Improvement",
          title: document.getElementById('siteTitle').value || "My Site",
          color: document.getElementById('siteColor').value || "#333",
          featMatrix: document.getElementById('featMatrix').checked.toString()
        };

        google.script.run.withSuccessHandler(xmlContent => {
           downloadFile("theme-" + config.type.replace(/\s+/g, '-').toLowerCase() + ".xml", xmlContent);
           btn.disabled = false;
           btn.innerText = "üì• Download Blogger Theme";
        }).generateThemeXml(config);
      }

      function downloadFile(filename, content) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/xml;charset=utf-8,' + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }
    </script>
  </body>
</html>
