<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Website Builder Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f0f2f5; font-family: sans-serif; padding: 20px; }
      .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
      .preview-box { background: #fff; border: 2px dashed #ddd; border-radius: 8px; padding: 15px; margin-top: 10px; min-height: 60px; }
    </style>
  </head>
  <body>
    <div class="card p-4">
      <div class="text-center mb-4">
        <h2>üõ†Ô∏è Website Builder Admin</h2>
        <p class="text-muted">Configure your site</p>
      </div>
      
      <form id="builderForm">
        <!-- Identity -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Website Title</label>
            <input type="text" class="form-control" id="siteTitle" value="Event Sushi">
          </div>
          <div class="col-md-6">
            <label class="form-label">Primary Color</label>
            <input type="color" class="form-control form-control-color w-100" id="siteColor" value="#fe7301">
          </div>
        </div>

        <!-- Category -->
        <div class="mb-3">
          <label class="form-label">Select Category</label>
          <select class="form-select" id="websiteType" onchange="updatePreview()">
            <option value="" disabled selected>Loading...</option>
          </select>
          <div id="subcatPreview" class="preview-box text-muted text-center small mt-2">
            Select a category to see Matrix codes...
          </div>
        </div>
        
        <div class="mb-4 form-check form-switch">
            <input class="form-check-input" type="checkbox" id="featMatrix" checked>
            <label class="form-check-label" for="featMatrix">Enable Matrix Navigation</label>
        </div>

        <!-- Actions -->
        <div class="d-grid">
          <button type="button" class="btn btn-success btn-lg" onclick="saveConfig()">
            üíæ Publish Changes
          </button>
        </div>
        <div id="status" class="mt-3 text-center"></div>
      </form>
    </div>

    <script>
      let allTypes = [];

      // Load categories
      google.script.run.withSuccessHandler(data => {
        allTypes = data.website_types;
        const select = document.getElementById('websiteType');
        select.innerHTML = '<option value="" disabled selected>Choose a category...</option>';
        allTypes.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = t.name;
          select.appendChild(opt);
        });
        
        // Load saved config
        google.script.run.withSuccessHandler(config => {
           if(config.title) document.getElementById('siteTitle').value = config.title;
           if(config.color) document.getElementById('siteColor').value = config.color;
           if(config.type) {
              select.value = config.type;
              updatePreview();
           }
        }).getSavedConfig();
        
      }).getWebsiteTypes();

      function updatePreview() {
        const typeName = document.getElementById('websiteType').value;
        const config = allTypes.find(t => t.name === typeName);
        if(config) {
           document.getElementById('siteColor').value = config.color || '#000000';
           document.getElementById('subcatPreview').innerHTML = config.subcategories.map((sub, i) => 
            `<span class="badge bg-secondary me-1">[${i+1}] ${sub}</span>`
           ).join(' ');
        }
      }

      function saveConfig() {
        const btn = document.querySelector('.btn-success');
        btn.disabled = true;
        btn.innerText = "Saving...";
        
        const config = {
          type: document.getElementById('websiteType').value,
          title: document.getElementById('siteTitle').value,
          color: document.getElementById('siteColor').value,
          featMatrix: document.getElementById('featMatrix').checked.toString()
        };

        if(!config.type) { alert("Select a category"); btn.disabled=false; return; }

        google.script.run.withSuccessHandler(() => {
           document.getElementById('status').innerHTML = '<div class="alert alert-success">Settings Saved! Refresh your blog.</div>';
           btn.disabled = false; 
           btn.innerText = "üíæ Publish Changes";
        }).saveConfigToSheet(config);
      }
    </script>
  </body>
</html>
